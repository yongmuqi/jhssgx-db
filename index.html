<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>基金持仓实时收益率（优化版）</title>
    <style>
        :root {
            --bg-main: #f5f7fa;
            --bg-card: #ffffff;
            --bg-light: #f8f9fa;
            --text-main: #333333;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --border: #e5e7eb;
            --primary: #4f46e5;
            --success: #10b981;
            --warning: #f97316;
            --danger: #ef4444;
            --profit: #e63946;
            --loss: #2a9d8f;
            --hover: #f1f5f9;
            --transition: all 0.3s ease;
        }
        .dark {
            --bg-main: #121212;
            --bg-card: #1e1e1e;
            --bg-light: #2d2d2d;
            --text-main: #f5f5f5;
            --text-secondary: #cccccc;
            --text-tertiary: #999999;
            --border: #3d3d3d;
            --hover: #333333;
            --profit: #ff6b6b;
            --loss: #4ecdc4;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", sans-serif;
            transition: var(--transition);
        }
        body {
            background: var(--bg-main);
            color: var(--text-main);
            padding: 16px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .container {
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-title {
            flex: 1;
        }
        .header h1 {
            font-size: 20px;
        }
        .header p {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        .theme-switch {
            width: 48px;
            height: 24px;
            border-radius: 12px;
            background: var(--bg-light);
            border: 1px solid var(--border);
            cursor: pointer;
            position: relative;
        }
        .theme-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            top: 1px;
            left: 1px;
            transition: var(--transition);
        }
        .theme-switch.dark::after {
            left: 25px;
            background: var(--warning);
        }
        .total {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--bg-light);
            border-radius: 8px;
        }
        .total-item {
            text-align: center;
            flex: 1;
            min-width: 100px;
        }
        .total-item .label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        .total-item .value {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-main);
        }
        .value.profit {
            color: var(--profit);
        }
        .value.loss {
            color: var(--loss);
        }
        .stats {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 20px;
        }
        .stats-card {
            flex: 1;
            min-width: 180px;
            padding: 12px;
            background: var(--bg-light);
            border-radius: 8px;
        }
        .stats-card h3 {
            font-size: 14px;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }
        .stats-content {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .stats-num {
            font-size: 20px;
            font-weight: bold;
        }
        .stats-chart {
            width: 70px;
            height: 70px;
        }
        .stats-list {
            list-style: none;
            font-size: 12px;
        }
        .stats-list li {
            padding: 3px 0;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .operate-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 16px;
            align-items: center;
        }
        .add-form {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            flex: 1;
            min-width: 280px;
        }
        .ocr-upload {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .add-form input, .ocr-upload input {
            flex: 1;
            min-width: 80px;
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            outline: none;
            background: var(--bg-card);
            color: var(--text-main);
            font-size: 14px;
        }
        .add-form input:focus {
            border-color: var(--primary);
        }
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition);
        }
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn-primary {
            background: var(--primary);
            color: #fff;
            min-width: 80px;
        }
        .btn-refresh {
            background: var(--warning);
            color: #fff;
            min-width: 80px;
        }
        .btn-clear {
            background: var(--danger);
            color: #fff;
            min-width: 80px;
        }
        .btn-del {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            padding: 3px 6px;
            font-size: 12px;
        }
        .btn-edit {
            background: rgba(79, 70, 229, 0.1);
            color: var(--primary);
            padding: 3px 6px;
            font-size: 12px;
            margin-right: 4px;
        }
        .btn-ocr {
            background: var(--success);
            color: #fff;
            min-width: 80px;
        }
        .btn-import {
            background: #6366f1;
            color: #fff;
            margin: 8px auto 0;
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
            margin-bottom: 20px;
            font-size: 14px;
        }
        th, td {
            padding: 8px 4px;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
        }
        th {
            background: var(--bg-light);
            font-weight: 600;
            color: var(--text-main);
            font-size: 12px;
        }
        tr:hover {
            background: var(--hover);
        }
        .empty {
            text-align: center;
            padding: 32px 0;
            color: var(--text-tertiary);
            font-size: 14px;
        }
        .ocr-preview {
            margin: 16px 0;
            padding: 12px;
            border: 1px dashed var(--border);
            border-radius: 8px;
            display: none;
        }
        .ocr-preview.show {
            display: block;
        }
        .ocr-preview h3 {
            font-size: 14px;
            color: var(--text-main);
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ocr-table td, .ocr-table th {
            padding: 6px 4px;
            font-size: 12px;
        }
        .img-preview {
            max-width: 180px;
            max-height: 120px;
            border-radius: 4px;
            margin: 0 auto 12px;
            display: block;
        }
        .mini-chart {
            width: 70px;
            height: 25px;
            margin: 0 auto;
        }
        .loading {
            color: var(--text-secondary);
            font-size: 12px;
            padding: 4px;
        }
        .num-format {
            font-variant-numeric: tabular-nums;
        }
        .tip {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: -8px;
            margin-bottom: 8px;
        }
        @media (max-width: 768px) {
            .total, .stats {
                flex-direction: column;
            }
            .stats-card {
                min-width: 100%;
            }
            .operate-bar, .add-form, .ocr-upload {
                flex-direction: column;
                align-items: stretch;
            }
            .btn {
                width: 100%;
            }
            .mini-chart {
                width: 60px;
            }
            .header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            th:nth-child(4), td:nth-child(4), th:nth-child(6), td:nth-child(6) {
                min-width: 60px;
            }
        }
        @media (max-width: 480px) {
            .container {
                padding: 12px;
            }
            .total-item {
                min-width: 80px;
            }
            .stats-card {
                min-width: 100%;
            }
            table {
                font-size: 12px;
            }
            th, td {
                padding: 6px 2px;
            }
        }
    </style>
    <!-- 引入依赖CDN（精简版，提升加载速度） -->
    <script src="https://cdn.bootcdn.net/ajax/libs/tesseract.js/5.0.2/tesseract.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script>
</head>
<body id="appBody">
    <div class="container">
        <div class="header">
            <div class="header-title">
                <h1>基金持仓实时收益率</h1>
                <p>数据：天天基金 | 识别：OCR | 支持图片批量导入</p>
            </div>
            <div class="theme-switch" id="themeSwitch" onclick="toggleTheme()"></div>
        </div>

        <!-- 总收益汇总 -->
        <div class="total">
            <div class="total-item">
                <div class="label">持仓总成本</div>
                <div class="value num-format" id="totalCost">¥0.00</div>
            </div>
            <div class="total-item">
                <div class="label">当前总市值</div>
                <div class="value num-format" id="totalValue">¥0.00</div>
            </div>
            <div class="total-item">
                <div class="label">累计收益</div>
                <div class="value num-format" id="totalProfit">¥0.00</div>
            </div>
            <div class="total-item">
                <div class="label">整体收益率</div>
                <div class="value num-format" id="totalRate">0.00%</div>
            </div>
        </div>

        <!-- 收益明细统计 -->
        <div class="stats">
            <div class="stats-card">
                <h3>收益分布</h3>
                <div class="stats-content">
                    <div class="stats-chart" id="profitPie"></div>
                    <div>
                        <div>盈利：<span class="stats-num" style="color:var(--profit)" id="profitCount">0</span>只</div>
                        <div>亏损：<span class="stats-num" style="color:var(--loss)" id="lossCount">0</span>只</div>
                    </div>
                </div>
            </div>
            <div class="stats-card">
                <h3>持仓市值TOP5</h3>
                <ul class="stats-list" id="topMarketList">
                    <li>暂无数据</li>
                </ul>
            </div>
            <div class="stats-card">
                <h3>收益率TOP5</h3>
                <ul class="stats-list" id="topRateList">
                    <li>暂无数据</li>
                </ul>
            </div>
        </div>

        <!-- 操作栏：手动添加 + 图片识别上传 -->
        <div class="operate-bar">
            <div class="add-form">
                <input type="text" id="fundCode" placeholder="基金代码（如000001）" onblur="matchFundNameByCode(this.value)" maxlength="6">
                <input type="text" id="fundName" placeholder="基金名称（自动匹配）" readonly>
                <input type="number" step="0.001" id="costPrice" placeholder="成本价" min="0.001">
                <input type="number" step="0.001" id="holdShare" placeholder="持有份额" min="0.001">
                <button class="btn btn-primary" onclick="addFund()">添加持仓</button>
            </div>
            <div class="ocr-upload">
                <!-- 移除capture="camera"，默认调相册 -->
                <input type="file" id="ocrFile" accept="image/*" hidden>
                <label for="ocrFile" class="btn btn-ocr">选择图片</label>
                <button class="btn btn-refresh" onclick="refreshAllFunds()">刷新数据</button>
                <button class="btn btn-clear" onclick="clearAllFunds()">清空持仓</button>
            </div>
        </div>
        <div class="tip">输入基金代码后失焦/点击添加，将自动匹配基金全称</div>

        <!-- OCR识别结果预览 -->
        <div class="ocr-preview" id="ocrPreview">
            <h3>
                图片识别待导入数据
                <span onclick="closeOcrPreview()" style="cursor:pointer;color:var(--text-tertiary)">×</span>
            </h3>
            <img src="" alt="预览图" class="img-preview" id="imgPreview">
            <table class="ocr-table" id="ocrTable">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="checkAll" onchange="checkAllOcr()"></th>
                        <th>基金名称</th>
                        <th>当前市值(¥)</th>
                        <th>收益额(¥)</th>
                        <th>匹配代码</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="ocrTableBody">
                    <tr class="empty">
                        <td colspan="6">暂无识别数据</td>
                    </tr>
                </tbody>
            </table>
            <button class="btn btn-import" onclick="importOcrData()">确认导入选中数据</button>
        </div>

        <!-- 基金持仓主表格 -->
        <table id="fundTable">
            <thead>
                <tr>
                    <th>基金代码</th>
                    <th>基金名称</th>
                    <th>成本价(¥)</th>
                    <th>持有份额</th>
                    <th>当前净值(¥)</th>
                    <th>净值走势</th>
                    <th>持仓成本(¥)</th>
                    <th>当前市值(¥)</th>
                    <th>收益(¥)</th>
                    <th>收益率(%)</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="fundTableBody">
                <tr class="empty">
                    <td colspan="11">暂无持仓，添加基金代码或上传图片开始追踪吧～</td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        // 全局配置 + 缓存（提升加载速度）
        const FUND_KEY = "fundHoldList";
        const THEME_KEY = "fundTheme";
        const FUND_API = "https://fund.eastmoney.com/ajax/fundNetValuation.aspx?fundCode=";
        const FUND_SEARCH_API = "https://fundsuggest.eastmoney.com/FundSearch/api/FundSearchAPI.ashx?m=1&key=";
        const FUND_KLINE_API = "https://api-fund.eastmoney.com/f10/lsjz?fundCode=";
        // 缓存对象：基金名称/净值/走势，避免重复请求
        const fundCache = { name: {}, net: {}, kline: {} };
        // 防抖函数（防止重复触发接口）
        function debounce(fn, delay = 500) { let timer; return (...args) => { clearTimeout(timer); timer = setTimeout(() => fn(...args), delay); }; }
        // 实例化（精简配置）
        const ocrWorker = Tesseract.createWorker({ langPath: 'https://cdn.bootcdn.net/ajax/libs/tesseract.js/5.0.2/worker', logger: () => {} });
        let ocrDataList = [];
        let chartInstances = {};
        numeral.defaultFormat('0,0.00');

        // 页面初始化（异步精简，提升首屏速度）
        window.onload = async function() {
            // 并行初始化，不阻塞首屏
            Promise.all([
                ocrWorker.load().then(() => ocrWorker.loadLanguage('chi_sim+eng')).then(() => ocrWorker.initialize('chi_sim+eng')),
                initTheme(),
                renderFundList(),
                calculateTotal(),
                renderStats()
            ]);
            // 绑定事件（延迟绑定，不阻塞首屏）
            setTimeout(() => {
                document.getElementById("ocrFile").addEventListener("change", handleOcrUpload);
            }, 300);
        };

        // 1. 主题切换（原有逻辑，无修改）
        function initTheme() {
            const savedTheme = localStorage.getItem(THEME_KEY) || 'light';
            const appBody = document.getElementById("appBody");
            const themeSwitch = document.getElementById("themeSwitch");
            if (savedTheme === 'dark') {
                appBody.classList.add('dark');
                themeSwitch.classList.add('dark');
            }
        }
        function toggleTheme() {
            const appBody = document.getElementById("appBody");
            const themeSwitch = document.getElementById("themeSwitch");
            const isDark = appBody.classList.contains('dark');
            isDark ? (appBody.classList.remove('dark'), themeSwitch.classList.remove('dark'), localStorage.setItem(THEME_KEY, 'light')) : (appBody.classList.add('dark'), themeSwitch.classList.add('dark'), localStorage.setItem(THEME_KEY, 'dark'));
            renderStats();
            renderFundList();
        }

        // 2. 图片选择修复：移除capture，默认调相册（HTML已改，此处无额外逻辑）
        async function handleOcrUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                document.getElementById("imgPreview").src = e.target.result;
                document.getElementById("ocrPreview").classList.add("show");
                // OCR识别（精简日志，提升速度）
                const result = await ocrWorker.recognize(file, { tessedit_pageseg_mode: 6 });
                ocrDataList = parseOcrText(result.data.text);
                // 批量匹配代码（防抖，避免请求过多）
                for (let i = 0; i < ocrDataList.length; i++) {
                    await matchFundCode(ocrDataList[i], i);
                }
                renderOcrTable();
            };
            reader.readAsDataURL(file);
            e.target.value = "";
        }

        // OCR解析（原有逻辑，精简）
        function parseOcrText(text) {
            const result = [];
            const lines = text.split(/\n|\r/).filter(line => line.trim() !== "");
            const moneyReg = /([+-]?\d+\.?\d*)/g;
            lines.forEach(line => {
                const trimLine = line.trim();
                if (trimLine.includes("合计") || trimLine.includes("总") || trimLine.length < 5) return;
                const moneyMatch = trimLine.match(moneyReg);
                if (moneyMatch && moneyMatch.length >= 2) {
                    let name = trimLine.replace(moneyReg, "").trim().replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, "");
                    const marketValue = parseFloat(moneyMatch[0]) || 0;
                    const profit = parseFloat(moneyMatch[1]) || 0;
                    if (name && marketValue > 0) result.push({ name, marketValue, profit, fundCode: "未匹配", isCheck: true });
                }
            });
            const uniqueNames = new Set();
            return result.filter(item => !uniqueNames.has(item.name) && (uniqueNames.add(item.name) || true));
        }

        // 3. 基金代码自动匹配名称（核心新增，带防抖+缓存）
        const matchFundNameByCode = debounce(async function(code) {
            const nameInput = document.getElementById("fundName");
            if (!code || code.length !== 6 || isNaN(code)) {
                nameInput.value = "";
                nameInput.readOnly = false;
                return;
            }
            // 先查缓存，再请求接口
            if (fundCache.name[code]) {
                nameInput.value = fundCache.name[code];
                return;
            }
            try {
                const response = await fetch(`${FUND_SEARCH_API}${code}`, {
                    headers: { "Referer": "https://fund.eastmoney.com/", "User-Agent": "Mozilla/5.0" },
                    timeout: 3000
                });
                const text = await response.text();
                const data = JSON.parse(text.match(/\{.*\}/)[0]);
                if (data.Data && data.Data.length > 0) {
                    const fundName = data.Data[0].NAME;
                    fundCache.name[code] = fundName; // 存入缓存
                    nameInput.value = fundName;
                    nameInput.readOnly = true;
                } else {
                    nameInput.value = "未匹配到基金";
                    nameInput.readOnly = false;
                }
            } catch (error) {
                nameInput.value = "匹配失败，请手动输入";
                nameInput.readOnly = false;
            }
        });

        // 基金代码匹配（原有逻辑，加缓存）
        async function matchFundCode(item, index) {
            if (fundCache.name[item.fundCode]) {
                ocrDataList[index].fundCode = fundCache.name[item.fundCode];
                return;
            }
            try {
                const response = await fetch(`${FUND_SEARCH_API}${encodeURIComponent(item.name)}`, { timeout: 3000 });
                const text = await response.text();
                const data = JSON.parse(text.match(/\{.*\}/)[0]);
                if (data.Data && data.Data.length > 0) {
                    ocrDataList[index].fundCode = data.Data[0].CODE;
                    fundCache.name[data.Data[0].CODE] = item.name; // 存入缓存
                }
            } catch (error) {
                ocrDataList[index].fundCode = "匹配失败";
            }
        }

        // OCR表格渲染（原有逻辑，精简）
        function renderOcrTable() {
            const tbody = document.getElementById("ocrTableBody");
            tbody.innerHTML = "";
            if (ocrDataList.length === 0) {
                tbody.innerHTML = '<tr class="empty"><td colspan="6">未识别到有效基金数据</td></tr>';
                return;
            }
            ocrDataList.forEach((item, index) => {
                const tr = document.createElement("tr");
                const profitColor = item.profit >=0 ? 'var(--profit)' : 'var(--loss)';
                tr.innerHTML = `
                    <td><input type="checkbox" ${item.isCheck ? "checked" : ""} onchange="ocrCheck(this, ${index})"></td>
                    <td title="${item.name}">${item.name.length > 10 ? item.name.substring(0,10)+'...' : item.name}</td>
                    <td class="num-format">${numeral(item.marketValue).format()}</td>
                    <td style="color:${profitColor}" class="num-format">${numeral(item.profit).format()}</td>
                    <td>${item.fundCode}</td>
                    <td><button class="btn btn-del" onclick="delOcrItem(${index})">删除</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // OCR选择操作（原有逻辑，无修改）
        function checkAllOcr() {
            const isCheck = document.getElementById("checkAll").checked;
            ocrDataList.forEach(item => item.isCheck = isCheck);
            renderOcrTable();
        }
        function ocrCheck(ele, index) {
            ocrDataList[index].isCheck = ele.checked;
        }
        function delOcrItem(index) {
            ocrDataList.splice(index, 1);
            renderOcrTable();
        }
        function closeOcrPreview() {
            document.getElementById("ocrPreview").classList.remove("show");
            ocrDataList = [];
        }

        // 导入OCR数据（加缓存，提升速度）
        async function importOcrData() {
            const selectData = ocrDataList.filter(item => item.isCheck && item.fundCode !== "未匹配" && item.fundCode !== "匹配失败");
            if (selectData.length === 0) {
                alert("请选择有效且匹配到基金代码的数据");
                return;
            }
            const fundList = getFundList();
            let successCount = 0;
            const refreshBtn = document.querySelector(".btn-refresh");
            refreshBtn.disabled = true;
            refreshBtn.innerText = "导入中...";
            for (let i = 0; i < selectData.length; i++) {
                const item = selectData[i];
                if (fundList.some(f => f.code === item.fundCode)) continue;
                // 查缓存，避免重复请求净值
                let net = fundCache.net[item.fundCode] || await getFundNetSync(item.fundCode);
                if (net <= 0) continue;
                fundCache.net[item.fundCode] = net; // 存入缓存
                const holdCost = (item.marketValue - item.profit).toFixed(2);
                const holdShare = (item.marketValue / net).toFixed(4);
                const costPrice = (holdCost / holdShare).toFixed(4);
                fundList.push({
                    code: item.fundCode,
                    name: item.name,
                    costPrice: parseFloat(costPrice),
                    holdShare: parseFloat(holdShare),
                    currentNet: net.toFixed(4),
                    holdCost: holdCost,
                    currentValue: item.marketValue.toFixed(2),
                    profit: item.profit.toFixed(2),
                    rate: ((item.profit / holdCost) * 100).toFixed(2)
                });
                successCount++;
            }
            saveFundList(fundList);
            renderFundList();
            calculateTotal();
            renderStats();
            closeOcrPreview();
            refreshBtn.disabled = false;
            refreshBtn.innerText = "刷新数据";
            alert(`导入完成！成功导入${successCount}只基金，其余跳过`);
        }

        // 基金净值请求（加缓存+超时，提升速度）
        async function getFundNetSync(code) {
            if (fundCache.net[code]) return fundCache.net[code];
            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 3000);
                const response = await fetch(`${FUND_API}${code}`, {
                    headers: { "Referer": "https://fund.eastmoney.com/", "User-Agent": "Mozilla/5.0" },
                    signal: controller.signal
                });
                clearTimeout(timeout);
                const text = await response.text();
                const netData = JSON.parse(text.match(/\{.*\}/)[0]);
                const net = parseFloat(netData.Data[0].gjz) || 0;
                fundCache.net[code] = net;
                return net;
            } catch (error) {
                return 0;
            }
        }

        // 异步获取净值（加缓存，提升速度）
        async function getFundNet(code, index) {
            try {
                let net = fundCache.net[code] || await getFundNetSync(code);
                if (isNaN(net) || net <= 0) return;
                const fundList = getFundList();
                fundList[index].currentNet = net.toFixed(4);
                fundList[index].currentValue = (net * fundList[index].holdShare).toFixed(2);
                fundList[index].profit = (fundList[index].currentValue - fundList[index].holdCost).toFixed(2);
                fundList[index].rate = ((fundList[index].profit / fundList[index].holdCost) * 100).toFixed(2);
                saveFundList(fundList);
                fundCache.net[code] = net;
                // 分批渲染，避免卡顿
                setTimeout(() => {
                    renderFundList();
                    calculateTotal();
                    renderStats();
                }, 100 * index);
            } catch (error) { console.error("获取净值失败：", error); }
        }

        // 基金走势数据（加缓存+异步，提升速度）
        async function getFundKlineData(code) {
            if (fundCache.kline[code]) return fundCache.kline[code];
            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 3000);
                const response = await fetch(`${FUND_KLINE_API}${code}&pageIndex=1&pageSize=7&startDate=&endDate=`, {
                    headers: { "Referer": "https://fund.eastmoney.com/", "User-Agent": "Mozilla/5.0" },
                    signal: controller.signal
                });
                clearTimeout(timeout);
                const data = await response.json();
                const klineData = data.Data && data.Data.LSJZList ? data.Data.LSJZList.reverse().map(item => parseFloat(item.DWJZ) || 0) : [];
                fundCache.kline[code] = klineData; // 存入缓存
                return klineData;
            } catch (error) {
                return [];
            }
        }

        // 迷你图渲染（精简配置，提升速度）
        function renderMiniChart(domId, data) {
            if (chartInstances[domId]) chartInstances[domId].dispose();
            const chart = echarts.init(document.getElementById(domId), null, { renderer: 'canvas' });
            chartInstances[domId] = chart;
            const isDark = document.getElementById("appBody").classList.contains('dark');
            const color = data.length > 0 && data[data.length-1] > data[0] ? 'var(--profit)' : 'var(--loss)';
            chart.setOption({
                backgroundColor: 'transparent',
                grid: { top: 0, right: 0, bottom: 0, left: 0 },
                xAxis: { show: false },
                yAxis: { show: false },
                series: [{
                    type: 'line',
                    data: data,
                    lineStyle: { color: color, width: 2 },
                    itemStyle: { color: color },
                    smooth: true,
                    areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: color + '40' }, { offset: 1, color: color + '00' }]) },
                    silent: true
                }],
                tooltip: { show: false }
            });
            // 防抖resize，避免多次重绘
            const resizeChart = debounce(() => chart.resize(), 500);
            window.addEventListener('resize', resizeChart);
        }

        // 持仓核心操作（优化添加逻辑，适配自动匹配）
        function getFundList() {
            const data = localStorage.getItem(FUND_KEY);
            return data ? JSON.parse(data) : [];
        }
        function saveFundList(list) {
            localStorage.setItem(FUND_KEY, JSON.stringify(list));
        }

        // 添加持仓（适配自动匹配名称，加校验）
        async function addFund() {
            const code = document.getElementById("fundCode").value.trim();
            let name = document.getElementById("fundName").value.trim() || "未命名";
            const costPrice = parseFloat(document.getElementById("costPrice").value);
            const holdShare = parseFloat(document.getElementById("holdShare").value);

            // 严格校验
            if (!code || code.length !== 6 || isNaN(code)) {
                alert("请输入6位有效基金代码");
                return;
            }
            if (isNaN(costPrice) || isNaN(holdShare) || costPrice <= 0 || holdShare <= 0) {
                alert("成本价/份额请输入大于0的有效数字");
                return;
            }
            // 未匹配名称时手动请求一次
            if (name === "未匹配到基金" || name === "匹配失败") {
                await matchFundNameByCode(code);
                name = document.getElementById("fundName").value.trim() || "未命名";
            }

            const fundList = getFundList();
            if (fundList.some(item => item.code === code)) {
                alert("该基金已在持仓中，请勿重复添加");
                return;
            }

            const newFund = {
                code, name, costPrice, holdShare,
                currentNet: 0, profit: 0, rate: 0,
                holdCost: (costPrice * holdShare).toFixed(2),
                currentValue: 0
            };
            fundList.push(newFund);
            saveFundList(fundList);
            // 分批渲染，避免卡顿
            setTimeout(() => {
                renderFundList();
                calculateTotal();
                renderStats();
            }, 200);
            // 清空表单
            document.getElementById("fundCode").value = "";
            document.getElementById("fundName").value = "";
            document.getElementById("costPrice").value = "";
            document.getElementById("holdShare").value = "";
            // 异步获取净值，不阻塞UI
            getFundNet(code, fundList.length - 1);
        }

        // 刷新所有基金（分批请求，避免卡顿）
        async function refreshAllFunds() {
            const fundList = getFundList();
            if (fundList.length === 0) {
                alert("暂无持仓，无需刷新");
                return;
            }
            const refreshBtn = document.querySelector(".btn-refresh");
            refreshBtn.disabled = true;
            refreshBtn.innerText = "刷新中...";
            // 分批请求，每2个一组，避免接口限流
            for (let i = 0; i < fundList.length; i += 2) {
                await Promise.all([
                    fundList[i] && getFundNet(fundList[i].code, i),
                    fundList[i+1] && getFundNet(fundList[i+1].code, i+1)
                ]);
            }
            refreshBtn.disabled = false;
            refreshBtn.innerText = "刷新数据";
            alert("所有基金数据已刷新完成");
        }

        // 编辑/删除/清空（原有逻辑，精简）
        function editFund(index) {
            const fundList = getFundList();
            const fund = fundList[index];
            const newCost = prompt("请修改成本价", fund.costPrice);
            const newShare = prompt("请修改持有份额", fund.holdShare);
            if (isNaN(newCost) || isNaN(newShare) || newCost <= 0 || newShare <= 0) {
                alert("请输入大于0的有效数字");
                return;
            }
            fund.costPrice = parseFloat(newCost);
            fund.holdShare = parseFloat(newShare);
            fund.holdCost = (fund.costPrice * fund.holdShare).toFixed(2);
            fund.currentValue = (fund.currentNet * fund.holdShare).toFixed(2);
            fund.profit = (fund.currentValue - fund.holdCost).toFixed(2);
            fund.rate = ((fund.profit / fund.holdCost) * 100).toFixed(2);
            saveFundList(fundList);
            renderFundList();
            calculateTotal();
            renderStats();
        }
        function delFund(index) {
            if (confirm("确定要删除该基金持仓吗？")) {
                const fundList = getFundList();
                const code = fundList[index].code;
                // 清除该基金缓存
                delete fundCache.name[code];
                delete fundCache.net[code];
                delete fundCache.kline[code];
                fundList.splice(index, 1);
                saveFundList(fundList);
                renderFundList();
                calculateTotal();
                renderStats();
            }
        }
        function clearAllFunds() {
            if (confirm("确定要清空所有基金持仓吗？数据将不可恢复！")) {
                localStorage.removeItem(FUND_KEY);
                // 清空所有缓存
                fundCache.name = {};
                fundCache.net = {};
                fundCache.kline = {};
                ocrDataList = [];
                for (let key in chartInstances) chartInstances[key].dispose();
                chartInstances = {};
                renderFundList();
                calculateTotal();
                renderStats();
            }
        }

        // 渲染持仓表格（异步分批，提升速度）
        async function renderFundList() {
            const fundList = getFundList();
            const tbody = document.getElementById("fundTableBody");
            tbody.innerHTML = "";

            if (fundList.length === 0) {
                tbody.innerHTML = '<tr class="empty"><td colspan="11">暂无持仓，添加基金代码或上传图片开始追踪吧～</td></tr>';
                return;
            }

            // 分批渲染，每5行一组，避免大数据量卡顿
            const batchSize = 5;
            for (let batch = 0; batch < Math.ceil(fundList.length / batchSize); batch++) {
                setTimeout(async () => {
                    const start = batch * batchSize;
                    const end = Math.min(start + batchSize, fundList.length);
                    for (let i = start; i < end; i++) {
                        const item = fundList[i];
                        const tr = document.createElement("tr");
                        const profitColor = item.profit >= 0 ? 'var(--profit)' : 'var(--loss)';
                        const rateColor = item.rate >= 0 ? 'var(--profit)' : 'var(--loss)';
                        const chartId = `miniChart_${i}`;
                        // 查缓存获取走势数据
                        const klineData = fundCache.kline[item.code] || await getFundKlineData(item.code);
                        tr.innerHTML = `
                            <td>${item.code}</td>
                            <td title="${item.name}">${item.name.length > 8 ? item.name.substring(0,8)+'...' : item.name}</td>
                            <td class="num-format">${numeral(item.costPrice).format()}</td>
                            <td class="num-format">${numeral(item.holdShare).format()}</td>
                            <td class="num-format">${numeral(item.currentNet).format()}</td>
                            <td><div class="mini-chart" id="${chartId}"></div></td>
                            <td class="num-format">${numeral(item.holdCost).format()}</td>
                            <td class="num-format">${numeral(item.currentValue).format()}</td>
                            <td style="color:${profitColor}" class="num-format">${numeral(item.profit).format()}</td>
                            <td style="color:${rateColor}" class="num-format">${numeral(item.rate).format()}%</td>
                            <td>
                                <button class="btn btn-edit" onclick="editFund(${i})">编辑</button>
                                <button class="btn btn-del" onclick="delFund(${i})">删除</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                        // 渲染迷你图
                        renderMiniChart(chartId, klineData);
                    }
                }, 100 * batch);
            }
        }

        // 计算总收益（原有逻辑，精简）
        function calculateTotal() {
            const fundList = getFundList();
            let totalCost = 0, totalValue = 0, totalProfit = 0, totalRate = 0;
            fundList.forEach(item => {
                totalCost += parseFloat(item.holdCost);
                totalValue += parseFloat(item.currentValue);
            });
            totalProfit = totalValue - totalCost;
            totalRate = totalCost === 0 ? 0 : (totalProfit / totalCost) * 100;

            document.getElementById("totalCost").innerText = `¥${numeral(totalCost).format()}`;
            document.getElementById("totalValue").innerText = `¥${numeral(totalValue).format()}`;
            const profitDom = document.getElementById("totalProfit");
            const rateDom = document.getElementById("totalRate");
            profitDom.innerText = `¥${numeral(totalProfit).format()}`;
            rateDom.innerText = `${numeral(totalRate).format()}%`;

            if (totalProfit >= 0) {
                profitDom.className = "value num-format profit";
                rateDom.className = "value num-format profit";
            } else {
                profitDom.className = "value num-format loss";
                rateDom.className = "value num-format loss";
            }
        }

        // 渲染收益统计（精简图表配置，提升速度）
        function renderStats() {
            const fundList = getFundList();
            const profitCount = fundList.filter(item => parseFloat(item.profit) > 0).length;
            const lossCount = fundList.filter(item => parseFloat(item.profit) < 0).length;
            const flatCount = fundList.filter(item => parseFloat(item.profit) === 0).length;

            document.getElementById("profitCount").innerText = profitCount;
            document.getElementById("lossCount").innerText = lossCount;

            // 饼图（精简配置，canvas渲染）
            const pieChart = echarts.init(document.getElementById("profitPie"), null, { renderer: 'canvas' });
            pieChart.setOption({
                backgroundColor: 'transparent',
                tooltip: { show: false },
                series: [{
                    type: 'pie',
                    radius: ['60%', '80%'],
                    data: [
                        { value: profitCount, name: '盈利', itemStyle: { color: 'var(--profit)' } },
                        { value: lossCount, name: '亏损', itemStyle: { color: 'var(--loss)' } },
                        { value: flatCount, name: '持平', itemStyle: { color: 'var(--text-tertiary)' } }
                    ],
                    label: { show: false },
                    silent: true
                }]
            });
            const resizePie = debounce(() => pieChart.resize(), 500);
            window.addEventListener('resize', resizePie);

            // TOP5列表（精简渲染）
            const topMarketList = fundList.sort((a, b) => parseFloat(b.currentValue) - parseFloat(a.currentValue)).slice(0,5);
            const topMarketDom = document.getElementById("topMarketList");
            topMarketDom.innerHTML = "";
            if (topMarketList.length === 0) {
                topMarketDom.innerHTML = '<li>暂无数据</li>';
            } else {
                topMarketList.forEach((item, i) => {
                    const li = document.createElement("li");
                    li.innerHTML = `<span>${i+1}. ${item.name.substring(0,6)}</span><span class="num-format">¥${numeral(item.currentValue).format()}</span>`;
                    topMarketDom.appendChild(li);
                });
            }

            const topRateList = fundList.sort((a, b) => parseFloat(b.rate) - parseFloat(a.rate)).slice(0,5);
            const topRateDom = document.getElementById("topRateList");
            topRateDom.innerHTML = "";
            if (topRateList.length === 0) {
                topRateDom.innerHTML = '<li>暂无数据</li>';
            } else {
                topRateList.forEach((item, i) => {
                    const li = document.createElement("li");
                    const color = parseFloat(item.rate) >=0 ? 'var(--profit)' : 'var(--loss)';
                    li.innerHTML = `<span>${i+1}. ${item.name.substring(0,6)}</span><span style="color:${color}" class="num-format">${numeral(item.rate).format()}%</span>`;
                    topRateDom.appendChild(li);
                });
            }
        }
    </script>
</body>
</html>
